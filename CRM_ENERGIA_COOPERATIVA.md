# CRM - Energia de Cooperativas

## ğŸ“‹ Modelo de NegÃ³cio

### Produto
**Energia Solar de Cooperativas** - O cliente adquire cota de energia gerada por usinas de cooperativas, sem necessidade de investimento em equipamentos.

### Como Funciona
1. Cliente se associa Ã  cooperativa
2. Adquire cota mensal de energia (kWh)
3. Energia Ã© injetada na rede da distribuidora
4. Distribuidora abate o consumo do cliente
5. Cliente paga apenas pela energia consumida (no futuro, quando houver abatimento)

### Diferencial
- âœ… **Sem investimento inicial** (nÃ£o compra painÃ©is/inversores)
- âœ… **Pagamento futuro** (quando houver abatimento na conta)
- âœ… **Sem obra** (energia vem da cooperativa)
- âœ… **Economia imediata** na conta de luz

---

## ğŸ¯ Funil de Vendas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CAPTAÃ‡ÃƒO DE LEADS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Landing Page      â”‚  Cadastro Manual                        â”‚
â”‚  (Empresa)         â”‚  - Por OPERATOR da Empresa              â”‚
â”‚                    â”‚  - Por OPERATOR de Partner              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      LEAD       â”‚
                    â”‚  (novo contato) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    [Triagem + Mapeamento]
                    âœ… Qual distribuidora atende?
                    âœ… Consumo mensal (kWh)?
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    SUSPECT      â”‚
                    â”‚  (qualificado)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                    [VerificaÃ§Ã£o de Disponibilidade]
                    âœ… Existe cooperativa na distribuidora?
                    âœ… Tem energia disponÃ­vel?
                              â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                                   â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    PROSPECT      â”‚              â”‚   SEM COBERTURA  â”‚
    â”‚ (tem disponib.)  â”‚              â”‚ (sem cooperativa)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
    [NegociaÃ§Ã£o]
    - Proposta de cota
    - Assinatura
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     CLIENTE      â”‚
    â”‚   (associado)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Regras de Acesso e Visibilidade

### Origem do Lead: Landing Page

**CaracterÃ­sticas**:
- `source: 'LANDING_PAGE'`
- `ownerId: null` (pertence Ã  empresa)
- `ownerType: 'EMPRESA'`

**Quem pode tratar**:
- âœ… ADMIN (qualquer um)
- âœ… COADMIN da empresa
- âœ… OPERATOR da empresa

**Quem pode ver**:
- âœ… ADMIN (todos)
- âœ… COADMIN (todos)
- âœ… OPERATOR da empresa (apenas leads da empresa)

---

### Origem do Lead: OPERATOR de Partner

**CaracterÃ­sticas**:
- `source: 'MANUAL'`
- `ownerId: partner-id`
- `ownerType: 'PARTNER'`
- `createdBy: operator-do-partner-id`

**Quem pode tratar**:
- âœ… ADMIN (qualquer um)
- âœ… COADMIN (qualquer um)
- âœ… OPERATOR do **mesmo partner** (apenas)

**Quem pode ver**:
- âœ… ADMIN (todos)
- âœ… COADMIN (todos)
- âœ… OPERATOR do **mesmo partner** (apenas seus leads)
- âŒ OPERATOR de outro partner (nÃ£o vÃª)

---

### Origem do Lead: OPERATOR da Empresa

**CaracterÃ­sticas**:
- `source: 'MANUAL'`
- `ownerId: null`
- `ownerType: 'EMPRESA'`
- `createdBy: operator-da-empresa-id`

**Quem pode tratar**:
- âœ… ADMIN (qualquer um)
- âœ… COADMIN da empresa
- âœ… OPERATOR da empresa

**Quem pode ver**:
- âœ… ADMIN (todos)
- âœ… COADMIN (todos)
- âœ… OPERATOR da empresa (apenas leads da empresa)
- âŒ OPERATOR de partner (nÃ£o vÃª)

---

## ğŸ“Š Estrutura de Dados

### Tabela: `leads`

```typescript
@Entity('leads')
export class Lead {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ORIGEM E PROPRIEDADE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({
    type: 'enum',
    enum: ['LANDING_PAGE', 'MANUAL'],
  })
  source: 'LANDING_PAGE' | 'MANUAL';

  @Column({
    type: 'enum',
    enum: ['EMPRESA', 'PARTNER'],
    name: 'owner_type',
  })
  ownerType: 'EMPRESA' | 'PARTNER';

  // Se ownerType = 'PARTNER', este campo aponta para o partner
  // Se ownerType = 'EMPRESA', este campo Ã© NULL
  @Column({ name: 'owner_id', nullable: true })
  ownerId?: string;

  @ManyToOne(() => Company, { nullable: true })
  @JoinColumn({ name: 'owner_id' })
  owner?: Company; // Partner que "possui" este lead

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DADOS BÃSICOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column()
  name: string;

  @Column()
  email: string;

  @Column()
  phone: string;

  @Column()
  city: string;

  @Column()
  state: string;

  @Column({ nullable: true })
  cep?: string;

  @Column({ nullable: true })
  street?: string;

  @Column({ nullable: true })
  number?: string;

  @Column({ nullable: true })
  complement?: string;

  @Column({ nullable: true })
  neighborhood?: string;

  @Column({ type: 'text', nullable: true })
  message?: string;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATUS NO FUNIL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({
    type: 'enum',
    enum: ['LEAD', 'SUSPECT', 'PROSPECT', 'CLIENTE', 'SEM_COBERTURA', 'DESCARTADO'],
    default: 'LEAD',
  })
  status: LeadStatus;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // QUALIFICAÃ‡ÃƒO (LEAD â†’ SUSPECT)
  // ObrigatÃ³rios para mudar de LEAD â†’ SUSPECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({ name: 'distributor_id', nullable: true })
  distributorId?: string;

  @ManyToOne(() => Distributor, { nullable: true })
  @JoinColumn({ name: 'distributor_id' })
  distributor?: Distributor;

  @Column({ type: 'decimal', precision: 10, scale: 2, nullable: true, name: 'monthly_consumption_kwh' })
  monthlyConsumptionKwh?: number; // Consumo mensal em kWh

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDAÃ‡ÃƒO DE DISPONIBILIDADE (SUSPECT â†’ PROSPECT)
  // Sistema verifica automaticamente antes de permitir PROSPECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({ name: 'cooperative_id', nullable: true })
  cooperativeId?: string;

  @ManyToOne(() => Cooperative, { nullable: true })
  @JoinColumn({ name: 'cooperative_id' })
  cooperative?: Cooperative; // Cooperativa que atenderÃ¡ (se houver)

  @Column({ type: 'boolean', default: false, name: 'has_availability' })
  hasAvailability: boolean; // TRUE se existe energia disponÃ­vel

  @Column({ type: 'decimal', precision: 10, scale: 2, nullable: true, name: 'available_energy_kwh' })
  availableEnergyKwh?: number; // Energia disponÃ­vel na cooperativa (snapshot)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROPOSTA (quando vira PROSPECT)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({ type: 'decimal', precision: 10, scale: 2, nullable: true, name: 'proposed_quota_kwh' })
  proposedQuotaKwh?: number; // Cota proposta (kWh/mÃªs)

  @Column({ type: 'decimal', precision: 10, scale: 2, nullable: true, name: 'monthly_savings' })
  monthlySavings?: number; // Economia mensal estimada (R$)

  @Column({ type: 'decimal', precision: 10, scale: 2, nullable: true, name: 'monthly_value' })
  monthlyValue?: number; // Valor mensal a pagar (R$)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GESTÃƒO DO FUNIL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({ name: 'assigned_to', nullable: true })
  assignedTo?: string;

  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'assigned_to' })
  assignedToUser?: User;

  @Column({ name: 'next_action_date', nullable: true })
  nextActionDate?: Date;

  @Column({ name: 'next_action_description', nullable: true })
  nextActionDescription?: string;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELACIONAMENTOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @OneToMany(() => LeadNote, (note) => note.lead)
  notes: LeadNote[];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AUDITORIA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({ name: 'company_id' })
  companyId: string; // Empresa principal do sistema

  @ManyToOne(() => Company)
  @JoinColumn({ name: 'company_id' })
  company: Company;

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date;

  @Column({ name: 'created_by', nullable: true })
  createdBy?: string;

  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'created_by' })
  createdByUser?: User;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONVERSÃƒO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @Column({ name: 'converted_to_client_id', nullable: true })
  convertedToClientId?: string;

  @Column({ name: 'converted_at', nullable: true })
  convertedAt?: Date;
}
```

---

## ğŸ”„ Fluxos de Trabalho

### Fluxo 1: Lead da Landing Page

**Dia 0 - 09:00**: Lead preenche formulÃ¡rio
```
Sistema cria:
- source: 'LANDING_PAGE'
- ownerType: 'EMPRESA'
- ownerId: null
- status: 'LEAD'
- companyId: empresa-principal-id
- createdBy: null (sistema)
```

**Dia 0 - 10:30**: OPERATOR da empresa visualiza e tria
```
OPERATOR acessa dashboard â†’ VÃª o lead
Abre modal de ediÃ§Ã£o:

Status: LEAD â†’ SUSPECT

Mapeamento obrigatÃ³rio:
- Distribuidora: [Dropdown] â†’ Seleciona "CPFL Paulista"
- Consumo Mensal (kWh): [Input] â†’ "450 kWh"

Nota:
[TRIAGEM] Lead qualificado como SUSPECT

Perfil:
- Residencial em Campinas/SP
- Distribuidora: CPFL Paulista
- Consumo: 450 kWh/mÃªs (~R$ 350/mÃªs)
- Cliente demonstrou grande interesse

PrÃ³xima AÃ§Ã£o:
- O quÃª: Verificar disponibilidade de cooperativa
- Quando: 04/01/2026
- Quem: JoÃ£o Silva
```

**Sistema valida**:
```typescript
// Antes de permitir SUSPECT, valida:
if (!lead.distributorId) {
  throw new BadRequestException('Distribuidora Ã© obrigatÃ³ria para status SUSPECT');
}
if (!lead.monthlyConsumptionKwh || lead.monthlyConsumptionKwh <= 0) {
  throw new BadRequestException('Consumo mensal (kWh) Ã© obrigatÃ³rio para status SUSPECT');
}

// Atualiza lead
lead.status = 'SUSPECT';
lead.distributorId = 'cpfl-paulista-id';
lead.monthlyConsumptionKwh = 450;
```

---

**Dia 3 - 06/01**: COADMIN verifica disponibilidade

```
COADMIN acessa lead â†’ Editar

Status: SUSPECT â†’ PROSPECT

Sistema AUTOMATICAMENTE verifica:
1. Busca cooperativas que atendem CPFL Paulista:
   SELECT * FROM cooperatives
   WHERE distributor_id = 'cpfl-paulista-id'
   AND available_energy > 0

2. Se encontrar cooperativa:
   - hasAvailability = true
   - cooperativeId = cooperativa-id
   - availableEnergyKwh = cooperative.available_energy (snapshot)
   - Permite status PROSPECT âœ…

3. Se NÃƒO encontrar:
   - hasAvailability = false
   - Bloqueia status PROSPECT âŒ
   - Sugere status SEM_COBERTURA

COADMIN preenche proposta:
- Cota Proposta: 400 kWh/mÃªs (88% do consumo)
- Valor Mensal: R$ 280/mÃªs
- Economia Mensal: R$ 70/mÃªs (20%)

Nota:
[QUALIFICAÃ‡ÃƒO] Lead promovido para PROSPECT

Disponibilidade confirmada:
âœ… Cooperativa: Cooperativa Solar Campinas
âœ… Energia disponÃ­vel: 15.000 kWh/mÃªs
âœ… Distribuidora: CPFL Paulista

Proposta:
- Cota: 400 kWh/mÃªs
- Valor: R$ 280/mÃªs
- Economia: R$ 70/mÃªs (20%)
- Cobertura: 88% do consumo

PrÃ³xima AÃ§Ã£o:
- O quÃª: Enviar proposta por email
- Quando: 07/01/2026
- Quem: Maria Santos
```

**Sistema atualiza**:
```typescript
// Valida disponibilidade
const cooperative = await this.cooperativeService.findAvailable(lead.distributorId);

if (!cooperative || cooperative.available_energy <= 0) {
  throw new BadRequestException(
    'NÃ£o hÃ¡ cooperativa com energia disponÃ­vel para esta distribuidora. ' +
    'Mova o lead para status SEM_COBERTURA.'
  );
}

// Atualiza lead
lead.status = 'PROSPECT';
lead.cooperativeId = cooperative.id;
lead.hasAvailability = true;
lead.availableEnergyKwh = cooperative.available_energy;
lead.proposedQuotaKwh = 400;
lead.monthlyValue = 280;
lead.monthlySavings = 70;
```

---

### Fluxo 2: Lead Manual de OPERATOR de Partner

**Dia 0 - 11:00**: OPERATOR do Partner "SolarVendas" cadastra lead

```
OPERATOR logado (parceiro SolarVendas):
- companyId: solarvendas-partner-id
- role: OPERATOR

Dashboard â†’ Cadastrar Lead Manualmente

FormulÃ¡rio:
- Nome: Ana Paula
- Email: ana@email.com
- Telefone: (19) 98888-7777
- Cidade: Campinas
- Estado: SP
- Mensagem: "IndicaÃ§Ã£o de cliente atual"

[Salvar]
```

**Sistema cria automaticamente**:
```typescript
const lead = {
  source: 'MANUAL',
  ownerType: 'PARTNER', // â† Detecta que criador Ã© OPERATOR de partner
  ownerId: currentUser.companyId, // â† Partner do OPERATOR
  companyId: mainCompanyId, // Empresa principal do sistema
  status: 'LEAD',
  createdBy: currentUser.id,
  // ... dados do formulÃ¡rio
};
```

**Resultado**:
- Lead pertence ao Partner "SolarVendas"
- Apenas OPERATORS deste partner podem ver/editar
- COADMIN/ADMIN veem todos

---

**Dia 1 - 12:00**: OPERATOR do mesmo partner tria

```
OPERATOR do SolarVendas acessa dashboard:
- VÃª apenas leads do partner SolarVendas âœ…
- NÃƒO vÃª leads da empresa âŒ
- NÃƒO vÃª leads de outros partners âŒ

Edita lead Ana Paula:
Status: LEAD â†’ SUSPECT

Distribuidora: Energisa Sul-Sudeste
Consumo: 800 kWh/mÃªs

[Salvar]
```

**Sistema valida**:
```typescript
// Verifica se OPERATOR pode editar este lead
if (lead.ownerType === 'PARTNER' && lead.ownerId !== currentUser.companyId) {
  throw new ForbiddenException('VocÃª sÃ³ pode editar leads do seu partner');
}

// Atualiza
lead.status = 'SUSPECT';
lead.distributorId = 'energisa-id';
lead.monthlyConsumptionKwh = 800;
```

---

**Dia 5 - 15/01**: COADMIN promove para PROSPECT

```
COADMIN (vÃª todos os leads):
- VÃª leads da empresa âœ…
- VÃª leads de todos os partners âœ…

Acessa lead Ana Paula (do partner SolarVendas)
Status: SUSPECT â†’ PROSPECT

Sistema verifica disponibilidade:
âŒ NÃ£o hÃ¡ cooperativa com energia disponÃ­vel na Energisa

COADMIN muda status: SEM_COBERTURA

Nota:
[SEM COBERTURA] Infelizmente nÃ£o temos cobertura

Distribuidora: Energisa Sul-Sudeste
Cooperativas consultadas: 3
Energia disponÃ­vel: 0 kWh

RecomendaÃ§Ã£o: Adicionar na lista de espera para quando houver expansÃ£o
```

---

### Fluxo 3: Lead Manual de OPERATOR da Empresa

**Dia 0 - 14:00**: OPERATOR da empresa cadastra lead

```
OPERATOR logado (empresa principal):
- companyId: empresa-principal-id
- role: OPERATOR

Dashboard â†’ Cadastrar Lead Manualmente

FormulÃ¡rio:
- Nome: Roberto Costa
- Email: roberto@email.com
- Telefone: (11) 97777-6666
- Cidade: SÃ£o Paulo
- Estado: SP
- Mensagem: "Cliente de cold call"

[Salvar]
```

**Sistema cria**:
```typescript
const lead = {
  source: 'MANUAL',
  ownerType: 'EMPRESA', // â† OPERATOR Ã© da empresa
  ownerId: null, // â† Empresa nÃ£o precisa de ownerId
  companyId: mainCompanyId,
  status: 'LEAD',
  createdBy: currentUser.id,
  // ... dados
};
```

**Resultado**:
- Lead pertence Ã  empresa
- COADMIN e OPERATORS da empresa podem ver/editar
- OPERATORS de partners NÃƒO veem âŒ

---

## ğŸ›¡ï¸ ImplementaÃ§Ã£o de SeguranÃ§a (Backend)

### Service: LeadsService

```typescript
@Injectable()
export class LeadsService {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FILTRAR LEADS POR PERMISSÃƒO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async findAll(currentUser: any): Promise<Lead[]> {
    const query = this.leadsRepository
      .createQueryBuilder('lead')
      .leftJoinAndSelect('lead.distributor', 'distributor')
      .leftJoinAndSelect('lead.cooperative', 'cooperative')
      .leftJoinAndSelect('lead.assignedToUser', 'assignedToUser')
      .leftJoinAndSelect('lead.notes', 'notes')
      .leftJoinAndSelect('notes.createdByUser', 'noteCreator');

    // ADMIN e COADMIN veem TODOS os leads
    if (currentUser.role === UserRole.ADMIN || currentUser.role === UserRole.COADMIN) {
      return query.getMany();
    }

    // OPERATOR vÃª apenas:
    // 1. Leads da EMPRESA (ownerType = 'EMPRESA')
    // 2. Leads do SEU PARTNER (ownerType = 'PARTNER' AND ownerId = seu companyId)

    query.andWhere(
      new Brackets((qb) => {
        // Leads da empresa
        qb.where("lead.ownerType = :ownerTypeEmpresa", { ownerTypeEmpresa: 'EMPRESA' })
          // OU leads do seu partner
          .orWhere(
            new Brackets((qb2) => {
              qb2.where("lead.ownerType = :ownerTypePartner", { ownerTypePartner: 'PARTNER' })
                .andWhere("lead.ownerId = :partnerId", { partnerId: currentUser.companyId });
            })
          );
      })
    );

    return query.getMany();
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDAR PERMISSÃƒO DE EDIÃ‡ÃƒO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async update(id: string, updateDto: UpdateLeadDto, currentUser: any): Promise<Lead> {
    const lead = await this.findOne(id);

    if (!lead) {
      throw new NotFoundException(`Lead com ID ${id} nÃ£o encontrado`);
    }

    // ADMIN e COADMIN podem editar qualquer lead
    if (currentUser.role === UserRole.ADMIN || currentUser.role === UserRole.COADMIN) {
      return this.performUpdate(lead, updateDto, currentUser);
    }

    // OPERATOR sÃ³ pode editar:
    // 1. Leads da EMPRESA (se for OPERATOR da empresa)
    // 2. Leads do SEU PARTNER (se for OPERATOR de partner)

    const canEdit =
      (lead.ownerType === 'EMPRESA') || // Lead da empresa
      (lead.ownerType === 'PARTNER' && lead.ownerId === currentUser.companyId); // Lead do seu partner

    if (!canEdit) {
      throw new ForbiddenException('VocÃª nÃ£o tem permissÃ£o para editar este lead');
    }

    return this.performUpdate(lead, updateDto, currentUser);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ATUALIZAR STATUS: LEAD â†’ SUSPECT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async performUpdate(lead: Lead, updateDto: UpdateLeadDto, currentUser: any): Promise<Lead> {
    // Se mudando para SUSPECT, validar campos obrigatÃ³rios
    if (updateDto.status === 'SUSPECT') {
      if (!updateDto.distributorId) {
        throw new BadRequestException('Distribuidora Ã© obrigatÃ³ria para status SUSPECT');
      }
      if (!updateDto.monthlyConsumptionKwh || updateDto.monthlyConsumptionKwh <= 0) {
        throw new BadRequestException('Consumo mensal (kWh) Ã© obrigatÃ³rio e deve ser maior que zero');
      }

      lead.distributorId = updateDto.distributorId;
      lead.monthlyConsumptionKwh = updateDto.monthlyConsumptionKwh;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ATUALIZAR STATUS: SUSPECT â†’ PROSPECT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    if (updateDto.status === 'PROSPECT') {
      // Validar que Ã© SUSPECT atualmente
      if (lead.status !== 'SUSPECT') {
        throw new BadRequestException('Apenas leads com status SUSPECT podem virar PROSPECT');
      }

      // Validar que distribuidora estÃ¡ definida
      if (!lead.distributorId) {
        throw new BadRequestException('Distribuidora deve estar definida antes de virar PROSPECT');
      }

      // Buscar cooperativa com disponibilidade
      const cooperative = await this.cooperativeService.findAvailableByDistributor(lead.distributorId);

      if (!cooperative || cooperative.availableEnergy <= 0) {
        throw new BadRequestException(
          `NÃ£o hÃ¡ cooperativa com energia disponÃ­vel para a distribuidora ${lead.distributor?.name || 'selecionada'}. ` +
          `Mova o lead para status SEM_COBERTURA.`
        );
      }

      // Atualizar lead com dados da cooperativa
      lead.cooperativeId = cooperative.id;
      lead.hasAvailability = true;
      lead.availableEnergyKwh = cooperative.availableEnergy;

      // Se proposta foi informada, atualizar
      if (updateDto.proposedQuotaKwh) {
        lead.proposedQuotaKwh = updateDto.proposedQuotaKwh;
      }
      if (updateDto.monthlyValue) {
        lead.monthlyValue = updateDto.monthlyValue;
      }
      if (updateDto.monthlySavings) {
        lead.monthlySavings = updateDto.monthlySavings;
      }
    }

    // Atualizar status
    if (updateDto.status) {
      lead.status = updateDto.status;
    }

    // Atualizar outros campos
    if (updateDto.assignedTo) {
      lead.assignedTo = updateDto.assignedTo;
    }
    if (updateDto.nextActionDate) {
      lead.nextActionDate = updateDto.nextActionDate;
    }
    if (updateDto.nextActionDescription) {
      lead.nextActionDescription = updateDto.nextActionDescription;
    }

    // Salvar
    await this.leadsRepository.save(lead);

    // Adicionar nota se fornecida
    if (updateDto.note) {
      const note = this.leadNoteRepository.create({
        leadId: lead.id,
        note: updateDto.note,
        createdBy: currentUser.id,
      });
      await this.leadNoteRepository.save(note);
    }

    // Retornar lead atualizado
    return this.findOne(lead.id);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CRIAR LEAD MANUAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async createManual(createDto: CreateLeadManualDto, currentUser: any): Promise<Lead> {
    // Determinar ownerType e ownerId baseado no criador
    let ownerType: 'EMPRESA' | 'PARTNER';
    let ownerId: string | null;

    // Se o usuÃ¡rio pertence a um partner, o lead Ã© do partner
    const userCompany = await this.companyService.findOne(currentUser.companyId);

    if (userCompany.isPartner) {
      ownerType = 'PARTNER';
      ownerId = currentUser.companyId;
    } else {
      ownerType = 'EMPRESA';
      ownerId = null;
    }

    const lead = this.leadsRepository.create({
      ...createDto,
      source: 'MANUAL',
      ownerType,
      ownerId,
      companyId: this.getMainCompanyId(), // Empresa principal do sistema
      status: 'LEAD',
      createdBy: currentUser.id,
    });

    const savedLead = await this.leadsRepository.save(lead);

    // Criar nota automÃ¡tica
    const note = this.leadNoteRepository.create({
      leadId: savedLead.id,
      note: `[CADASTRO MANUAL] Lead adicionado por ${currentUser.name}\n\nOrigem: Cadastro manual\nTipo: ${ownerType}`,
      createdBy: currentUser.id,
    });
    await this.leadNoteRepository.save(note);

    return this.findOne(savedLead.id);
  }
}
```

---

## ğŸ“‹ Interface do Sistema

### Dashboard de Leads (com filtro por visibilidade)

**Para COADMIN/ADMIN**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard de Leads                          [+ Novo Lead]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   LEADS     â”‚  SUSPECTS   â”‚  PROSPECTS  â”‚  CLIENTES   â”‚ â”‚
â”‚  â”‚     45      â”‚     28      â”‚     12      â”‚      8      â”‚ â”‚
â”‚  â”‚ Empresa: 30 â”‚ Empresa: 18 â”‚ Empresa: 8  â”‚ Empresa: 5  â”‚ â”‚
â”‚  â”‚ Partners:15 â”‚ Partners:10 â”‚ Partners: 4 â”‚ Partners: 3 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  Filtros:                                                     â”‚
â”‚  [Status â–¼] [Origem â–¼] [ProprietÃ¡rio â–¼] [Vendedor â–¼]        â”‚
â”‚                                                               â”‚
â”‚  ProprietÃ¡rio:                                                â”‚
â”‚  ( ) Todos                                                    â”‚
â”‚  ( ) Empresa                                                  â”‚
â”‚  ( ) Partners                                                 â”‚
â”‚  ( ) Partner: SolarVendas                                    â”‚
â”‚  ( ) Partner: EnergiaPro                                     â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Nome      Email         Origem    ProprietÃ¡rio Status â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ JoÃ£o Silva joao@...    Landing   EMPRESA      SUSPECTâ”‚  â”‚
â”‚  â”‚ Ana Costa  ana@...     Manual    SolarVendas  LEAD   â”‚  â”‚
â”‚  â”‚ Carlos Ed  carlos@...  Manual    EMPRESA      PROSPECTâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Para OPERATOR da Empresa**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard de Leads                          [+ Novo Lead]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… VocÃª vÃª: Leads da EMPRESA                                â”‚
â”‚  âŒ VocÃª NÃƒO vÃª: Leads de Partners                           â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   LEADS     â”‚  SUSPECTS   â”‚  PROSPECTS  â”‚  CLIENTES   â”‚ â”‚
â”‚  â”‚     30      â”‚     18      â”‚      8      â”‚      5      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Nome      Email         Origem    Status             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ JoÃ£o Silva joao@...    Landing   SUSPECT             â”‚  â”‚
â”‚  â”‚ Carlos Ed  carlos@...  Manual    PROSPECT            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Para OPERATOR de Partner (ex: SolarVendas)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard de Leads - SolarVendas            [+ Novo Lead]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… VocÃª vÃª: Leads do SEU PARTNER (SolarVendas)              â”‚
â”‚  âŒ VocÃª NÃƒO vÃª: Leads da Empresa                            â”‚
â”‚  âŒ VocÃª NÃƒO vÃª: Leads de outros Partners                    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   LEADS     â”‚  SUSPECTS   â”‚  PROSPECTS  â”‚  CLIENTES   â”‚ â”‚
â”‚  â”‚     15      â”‚     10      â”‚      4      â”‚      3      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Nome      Email         Origem    Status             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Ana Costa  ana@...     Manual    LEAD                â”‚  â”‚
â”‚  â”‚ Maria S    maria@...   Manual    SUSPECT             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Modal de EdiÃ§Ã£o: LEAD â†’ SUSPECT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Editar Lead: JoÃ£o Silva                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘ InformaÃ§Ãµes BÃ¡sicas                                   â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  Nome: JoÃ£o Silva                                            â”‚
â”‚  Email: joao@email.com                                       â”‚
â”‚  Telefone: (19) 98765-4321                                   â”‚
â”‚  Cidade/UF: Campinas/SP                                      â”‚
â”‚  Origem: Landing Page                                        â”‚
â”‚  ProprietÃ¡rio: EMPRESA                                       â”‚
â”‚                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                               â”‚
â”‚  Status Atual: LEAD                                          â”‚
â”‚                                                               â”‚
â”‚  Atualizar Status *                                          â”‚
â”‚  [Dropdown: LEAD, SUSPECT, DESCARTADO]                      â”‚
â”‚                                                               â”‚
â”‚  âš ï¸ Para mudar para SUSPECT, preencha os campos abaixo:     â”‚
â”‚                                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘ Mapeamento (ObrigatÃ³rio para SUSPECT)                 â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                               â”‚
â”‚  Distribuidora *                                             â”‚
â”‚  [Dropdown: Selecione...]                                   â”‚
â”‚  â”œâ”€ CPFL Paulista                                           â”‚
â”‚  â”œâ”€ Energisa Sul-Sudeste                                    â”‚
â”‚  â”œâ”€ EDP SÃ£o Paulo                                           â”‚
â”‚  â””â”€ Enel SÃ£o Paulo                                          â”‚
â”‚                                                               â”‚
â”‚  Consumo Mensal (kWh) *                                      â”‚
â”‚  [Input: 450] kWh/mÃªs                                        â”‚
â”‚                                                               â”‚
â”‚  ğŸ’¡ Dica: Consultar conta de luz do cliente                  â”‚
â”‚                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                               â”‚
â”‚  Adicionar Nota                                              â”‚
â”‚  [Textarea: Lead qualificado...]                            â”‚
â”‚                                                               â”‚
â”‚  [Cancelar]                              [Salvar AlteraÃ§Ãµes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Modal de EdiÃ§Ã£o: SUSPECT â†’ PROSPECT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Editar Lead: JoÃ£o Silva                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Status Atual: SUSPECT                                       â”‚
â”‚                                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘ Dados de QualificaÃ§Ã£o                                  â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  Distribuidora: CPFL Paulista âœ…                             â”‚
â”‚  Consumo: 450 kWh/mÃªs âœ…                                     â”‚
â”‚                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                               â”‚
â”‚  Atualizar Status                                            â”‚
â”‚  [Dropdown: SUSPECT, PROSPECT, SEM_COBERTURA, DESCARTADO]   â”‚
â”‚                                                               â”‚
â”‚  âš ï¸ Ao selecionar PROSPECT, o sistema verifica:             â”‚
â”‚  âœ… Existe cooperativa para CPFL Paulista?                   â”‚
â”‚  âœ… Tem energia disponÃ­vel?                                  â”‚
â”‚                                                               â”‚
â”‚  [Verificar Disponibilidade Agora]                           â”‚
â”‚                                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘ Resultado da VerificaÃ§Ã£o                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  âœ… Cooperativa encontrada!                                  â”‚
â”‚  ğŸ“ Cooperativa Solar Campinas                               â”‚
â”‚  âš¡ Energia disponÃ­vel: 15.000 kWh/mÃªs                       â”‚
â”‚  ğŸ“Š Atende distribuidora: CPFL Paulista                      â”‚
â”‚                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘ Proposta (Preencher se PROSPECT)                       â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                               â”‚
â”‚  Cota Proposta (kWh/mÃªs)                                     â”‚
â”‚  [Input: 400] kWh/mÃªs                                        â”‚
â”‚  (88% do consumo total)                                      â”‚
â”‚                                                               â”‚
â”‚  Valor Mensal (R$)                                           â”‚
â”‚  [Input: 280.00] R$/mÃªs                                      â”‚
â”‚                                                               â”‚
â”‚  Economia Mensal Estimada (R$)                               â”‚
â”‚  [Input: 70.00] R$/mÃªs                                       â”‚
â”‚  (20% de economia)                                           â”‚
â”‚                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                               â”‚
â”‚  Adicionar Nota                                              â”‚
â”‚  [Textarea: Lead promovido para PROSPECT...]                â”‚
â”‚                                                               â”‚
â”‚  [Cancelar]                              [Salvar AlteraÃ§Ãµes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Caso SEM COBERTURA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Editar Lead: Ana Costa                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Status Atual: SUSPECT                                       â”‚
â”‚                                                               â”‚
â”‚  Distribuidora: Energisa Sul-Sudeste âœ…                      â”‚
â”‚  Consumo: 800 kWh/mÃªs âœ…                                     â”‚
â”‚                                                               â”‚
â”‚  [Verificar Disponibilidade Agora]                           â”‚
â”‚                                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘ Resultado da VerificaÃ§Ã£o                               â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  âŒ Sem cobertura                                            â”‚
â”‚  ğŸ“ NÃ£o hÃ¡ cooperativa com energia disponÃ­vel                â”‚
â”‚  ğŸ“Š Distribuidora: Energisa Sul-Sudeste                      â”‚
â”‚  âš ï¸  Cooperativas consultadas: 3                             â”‚
â”‚  âš ï¸  Energia disponÃ­vel: 0 kWh                               â”‚
â”‚                                                               â”‚
â”‚  ğŸ’¡ RecomendaÃ§Ã£o:                                            â”‚
â”‚  - Mude status para SEM_COBERTURA                            â”‚
â”‚  - Adicione lead na lista de espera                          â”‚
â”‚  - Notifique quando houver expansÃ£o                          â”‚
â”‚                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                               â”‚
â”‚  Atualizar Status                                            â”‚
â”‚  [Dropdown: SEM_COBERTURA (recomendado)]                    â”‚
â”‚                                                               â”‚
â”‚  [Cancelar]                              [Salvar AlteraÃ§Ãµes] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Roadmap de ImplementaÃ§Ã£o

### Sprint 1: MigraÃ§Ã£o Base âœ… (Atual)
- [ ] Migration: Renomear `contacts` â†’ `leads`
- [ ] Adicionar campos: `ownerType`, `ownerId`, `source`
- [ ] Adicionar campos de qualificaÃ§Ã£o: `distributorId`, `monthlyConsumptionKwh`
- [ ] Adicionar campos de disponibilidade: `cooperativeId`, `hasAvailability`
- [ ] Migrar dados existentes

### Sprint 2: Regras de Acesso ğŸ”
- [ ] Implementar filtros por `ownerType` e `ownerId`
- [ ] Service: `findAll()` com filtro por permissÃ£o
- [ ] Guard: validar ediÃ§Ã£o por permissÃ£o
- [ ] Testes de permissÃ£o

### Sprint 3: Cadastro Manual ğŸ“
- [ ] Backend: Endpoint `POST /leads/manual`
- [ ] Frontend: FormulÃ¡rio de cadastro manual
- [ ] Detectar `ownerType` automaticamente
- [ ] Criar nota automÃ¡tica de cadastro

### Sprint 4: QualificaÃ§Ã£o (LEAD â†’ SUSPECT) ğŸ“Š
- [ ] Backend: ValidaÃ§Ã£o de campos obrigatÃ³rios
- [ ] Frontend: Campos de distribuidora e consumo
- [ ] Dropdown de distribuidoras
- [ ] ValidaÃ§Ã£o no submit

### Sprint 5: Disponibilidade (SUSPECT â†’ PROSPECT) âš¡
- [ ] Backend: VerificaÃ§Ã£o automÃ¡tica de cooperativa
- [ ] Service: `findAvailableByDistributor()`
- [ ] Frontend: BotÃ£o "Verificar Disponibilidade"
- [ ] Feedback visual (âœ… tem / âŒ sem cobertura)

### Sprint 6: Proposta e ConversÃ£o ğŸ’°
- [ ] Campos de proposta: `proposedQuotaKwh`, `monthlyValue`, `monthlySavings`
- [ ] Frontend: FormulÃ¡rio de proposta
- [ ] CÃ¡lculo automÃ¡tico de economia
- [ ] ConversÃ£o PROSPECT â†’ CLIENTE

### Sprint 7: Dashboard e Analytics ğŸ“ˆ
- [ ] Dashboard separado por proprietÃ¡rio
- [ ] Filtros avanÃ§ados
- [ ] KPIs por empresa/partner
- [ ] RelatÃ³rios de conversÃ£o

### Sprint 8: AutomaÃ§Ãµes ğŸ¤–
- [ ] NotificaÃ§Ã£o quando cooperativa tiver energia disponÃ­vel
- [ ] Lista de espera para SEM_COBERTURA
- [ ] Follow-ups automÃ¡ticos
- [ ] IntegraÃ§Ã£o com cooperativas (API)

---

## ğŸ“ Resumo das Regras

### âœ… PermissÃµes de VisualizaÃ§Ã£o

| Perfil | Leads Empresa | Leads Partners | Leads EspecÃ­fico |
|--------|---------------|----------------|------------------|
| ADMIN | âœ… Todos | âœ… Todos | âœ… Todos |
| COADMIN | âœ… Todos | âœ… Todos | âœ… Todos |
| OPERATOR (Empresa) | âœ… Sim | âŒ NÃ£o | âŒ NÃ£o |
| OPERATOR (Partner X) | âŒ NÃ£o | âœ… Apenas Partner X | âŒ NÃ£o |

### âœ… Campos ObrigatÃ³rios por Status

**LEAD â†’ SUSPECT**:
- âœ… `distributorId` (qual distribuidora atende)
- âœ… `monthlyConsumptionKwh` (consumo em kWh/mÃªs)

**SUSPECT â†’ PROSPECT**:
- âœ… Sistema verifica automaticamente disponibilidade
- âœ… Bloqueia se nÃ£o houver cooperativa disponÃ­vel
- âœ… Sugere status `SEM_COBERTURA` se nÃ£o houver

**PROSPECT â†’ CLIENTE**:
- âœ… Proposta aceita
- âœ… Contrato assinado

---

**VersÃ£o**: 3.0 - Energia de Cooperativas
**Ãšltima AtualizaÃ§Ã£o**: 03/01/2026
**Modelo**: Multi-tenant com Partners
